name: CI

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  ci:
    name: Run Test and Review PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4

      - name: Detect whether code changed
        id: changed
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request
            if (!pr) {
              core.setOutput('code', 'true')
              return
            }
            const owner = pr.base.repo.owner.login
            const repo = pr.base.repo.name
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number: pr.number })
            const paths = files.map(f => f.filename)

            const isDoc = (p) => (
              p.startsWith('locales/') ||
              p === 'README.md' ||
              p.startsWith('README.') ||
              p === 'LICENSE' ||
              p === 'CONTRIBUTING.md' ||
              p === 'CODE_OF_CONDUCT.md' ||
              p === 'sources/translation.json'
            )

            const codeChanged = paths.some(p => !isDoc(p))
            core.setOutput('code', codeChanged ? 'true' : 'false')
            core.setOutput('files', paths.join('\n'))

      - name: Docs-only PR (skip)
        if: ${{ steps.changed.outputs.code != 'true' }}
        run: |
          echo "Docs-only PR detected; skipping comprehensive CI."

      - name: Setup Python 3.13 üêç
        if: ${{ steps.changed.outputs.code == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: 3.13
          cache: 'pip'

      - name: Install Dependencies üì•
        if: ${{ steps.changed.outputs.code == 'true' }}
        run: pip install -r requirements.txt

      - name: Run comprehensive CI (real GitHub, mock WakaTime) üß™
        if: ${{ steps.changed.outputs.code == 'true' }}
        env:
          MOCK_WAKATIME: True
          MOCK_DATA_DIR: mock_data
          DEBUG_RUN: True
          INPUT_DEBUG_LOGGING: True

          INPUT_GH_TOKEN: ${{ github.token }}
          # Stats of the PR Author are generated, not owner's
          INPUT_GH_USER: ${{ github.event.pull_request.user.login }}

          INPUT_SYMBOL_VERSION: 1
          INPUT_SHOW_TIMEZONE: True
          INPUT_SHOW_PROJECTS: True
          INPUT_SHOW_EDITORS: True
          INPUT_SHOW_OS: True
          INPUT_SHOW_LANGUAGE: True
          INPUT_SHOW_LINES_OF_CODE: True
          INPUT_SHOW_LOC_CHART: True
          INPUT_SHOW_PROFILE_VIEWS: False
          INPUT_SHOW_TOTAL_CODE_TIME: True
          INPUT_SHOW_SHORT_INFO: True
          INPUT_SHOW_COMMIT: True
          INPUT_SHOW_DAYS_OF_WEEK: True
          INPUT_SHOW_LANGUAGE_PER_REPO: True
          INPUT_SHOW_UPDATED_DATE: True

        run: python3 sources/main.py
